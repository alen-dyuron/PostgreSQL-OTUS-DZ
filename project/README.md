# Проектная работа

## Тема

Создание и тестирование высоконагруженного отказоустойчивого кластера PostgreSQL на базе Patroni

## Цель и задачи проекта

Цель проекта: Создать высокодоступный кластер PostgreSQL, развёртывание и обслуживание которого будут автоматизированы модулями Patroni и etcd, и тестировать отказоустойчивость кластера в рамках планированного и непланированного переключения роли.

- [x] Создание виртуалной кластеризованной среды Ubuntu c распределённом хранилищем конфигурации etcd
- [ ] Настраивание модули управления Patroni
- [ ] Тестирование переключения и отказоустойчивости кластера
- [ ] ...


> [!NOTE]
> Здесь показано галочками какие задачи были выполнены


## Архитектура

### Используеммые технрлогии

Для выполнения этого проекта исползовались следующие текнологии 

| Роль                                        | Название                           | Версия                            | Коментарии               |
| ------------------------------------------- | ---------------------------------- | --------------------------------- | ------------------------ |
| Слой виртуализации                          | Oracle VM Virtualbox               | Версия 7.0.22 r165102 (Qt5.15.2)  |                          |
| ОЦ кластера                                 | Ubuntu                             | 24.04 LTS (серверный)             |                          |
| DCS (распределённое хранилище конфигурации) | etcd                               | 3.4.30                            | repository (precompiled) |
| Слой отказоустойчивости Postgres            | Patroni                            |                                   |                          |
| База данных                                 | Postgres                           | 18                                | repository (precompiled) |

### Сетевая топологиа

Подсети виртуальной среды былти настроены вот таким образом для выполнения этого проекта:

| Network name                     | Подсеть          | Маск          | Исползование           |
| -------------------------------- | ---------------- | ------------- | ---------------------- |
| VirtualBox Host-Only Adapter     | 192.168.56.1/24  | 255.255.255.0 | postgres кластер IPs   |
| VirtualBox Host-Only Adapter #2  | 192.168.47.1/24  | 255.255.255.0 | etcd кластер IPs       |

Виртуальные машины кластера имеют сдедующа сетевая топология:

| Название хоста          | Название DCS         | Общий IP      | Айпи етсд     | Исползование                    |
| ----------------------- | -------------------- | ------------- | ------------- | ------------------------------- | 
| ubt-pg-aduron-dbnode1   | ubt-pg-aduron-etcd1  | 192.168.56.10 | 192.168.47.10 | Мастер кластера Postgres        |
| ubt-pg-aduron-dbnode2   | ubt-pg-aduron-etcd2  | 192.168.56.20 | 192.168.47.20 | Реплиса кластера Postgres       |
| ubt-pg-aduron-cluster3  | ubt-pg-aduron-etcd3  | 192.168.56.30 | 192.168.47.30 | Допольнительный DCS-хост        |

> [!NOTE]
> Также отмечаем, что каждая машина имеет допольнительный сетеввой доступ типа NAT, который используется для их полключения к интернету.


### Диаграм архитектуры



## Выполнение проекта


### Создание виртуалной кластеризованной среды Ubuntu c распределённом хранилищем конфигурации etcd


#### Создание сетевой конфигурации

По умолчанию, Oracle VM VirtualBox предоставляет одну подсеть типа *Virtual Host Adapter* (виртуальный адаптер хоста), которая полволяет подключаться к ВМ с хоста. Однако для создания более [реалистичной архитектуры](#сетевая-топологиа), нам понадобится и одна допольнительная подсеть для управления кластером etcd. Создать её в VirtualBox можно следующим образом:

Выбрать меню *Файл / Инструменты / Менеджер Сетей*, затем нажать кнопку *Создать*
</br><img src="img/1_vm_install/net-1.png" width="1000" />  

Заполнить детали новой подсети таким способом:
</br><img src="img/1_vm_install/net-2.png" width="1000" />


#### Установление первой виртуалной машины

> [!NOTE]
> Предварительно [cкачать Ubuntu Server 24.04 LTS](https://ubuntu.com/download/server)

В данном случае, установим первую виртуалную машину, со всеми нужными компнентами и утилитами, а дальше сможем её клонировать для интеграция допольнительных хостов, что ускорит процесс установления всего кластера. Для создания новой виртуальной машины, выбираем кнокпу *Создать* и дальше выполняем следующие шаги:
- В разделе *Имя и тип ОЦ* выбираем имя, образ ISO, папку, тип и версию Линукса. 
- В разделе *Автоматическая установка* добавляем детали пользователя и хоста
- В разделе *Обарудование* выбираем выделенные ресурсы нашей ВМ.
- В разделе *Жёсткий диск* заполняем детали виртуального диска (расположение, размер, тип VDI, без выделения места в полном размере)

<details>
<summary>Шаг 1: Выбор виртуальной конфигурации</summary>
</br><img src="img/1_vm_install/create-1.png" width="800" />
</br><img src="img/1_vm_install/create-2.png" width="800" />
</br><img src="img/1_vm_install/create-3.png" width="800" />
</br><img src="img/1_vm_install/create-4.png" width="800" />
</details>

> [!WARNING]
> При этом, автоматическая установка не всегда запускается как запрошено, и её доступность зависит по всей видимости от вывранного образа ISO. В данном случае приходится всё же заполнить все детали занова при установке.

Дальше, выбираем кнопку *Готого*, что создавает виртуалный диск, выделяет ресурсы, и запускает процесс установки. Однако сразу же остановим машину после запуска, и переидём в разделе *Сеть* (на главном екране, либо через менью *Машина / Настроить*). Здесь включаем адаптеры 1, 2 и 3 согласно [выбраной сетевой конфигурации](#сетевая-топологиа). 

<details>
<summary>Шаг 2: Выбор сетевой конфигурации ВМ</summary>
</br><img src="img/1_vm_install/create-5.png" width="800" />
</br><img src="img/1_vm_install/create-6.png" width="800" />
</br><img src="img/1_vm_install/create-7.png" width="800" />
</details>


После выполнения сетевой конфигурации, можно снова закускать ВМ и начинать процесс установления. Он происходит следующим образом:
1. Определение языка и настроек клавятуры.
2. Выбор метода установки (выбираем *Ubuntu Server* )
3. Дальше настраиваем сеть таким образом:
   - для интерфейса *enp0s8* отключаем DHCP и выбираем значение *Manual* для *IPv4 Method*
   - поставляем айпи 192.168.56.10 для *enp0s8*
   - поставляем айпи 192.168.47.10 для *enp0s9* (подсеть etcd). Для этого интерфейса не требуеться отключения DHCP так как он отключен изначално
   - Проху оставляем как есть, а также оставляем зеркало установления по умолчанию
4. Настройки хранилища и партиционирования, профиль пользователя:
   - *Use an entire disk* (использовать весь диска)
   - *Set up LVM*
   - В разделе *profile configuration*, заполняем данные главного пользователя 
   - Ставим OpenSSH (требуется попозже во время внешнего подключения)
5. Дальше можно добавить различные репозитории сторонных ПО.
   - В данном случае можно добавить *etcd*, 
   - Также можно сразк же указать, к какой версии мы хотим получить доступ. Здесь выбираем самую свежую стабтльную версию (среди предоставленных).

<details>
<summary>Шаг 3.1: Определение языка и настроек клавятуры</summary>
</br><img src="img/1_vm_install/install-1.png" width="800" />
</br><img src="img/1_vm_install/install-2.png" width="1000" />
</br><img src="img/1_vm_install/install-3.png" width="1000" />
</details>

<details>
<summary>Шаг 3.2: Выбор метода установки</summary>
</br><img src="img/1_vm_install/install-4.png" width="1000" />
</details>

<details>
<summary>Шаг 3.3: Сетевые настроики, прокси, зеркало</summary>
</br><img src="img/1_vm_install/install-5.png" width="1000" />
</br><img src="img/1_vm_install/install-6.png" width="1000" />
</br><img src="img/1_vm_install/install-7.png" width="1000" />
</br><img src="img/1_vm_install/install-8.png" width="1000" />
</br><img src="img/1_vm_install/install-9.png" width="1000" />

</br><img src="img/1_vm_install/install-10.png" width="1000" />
</br><img src="img/1_vm_install/install-11.png" width="1000" />
</details>

<details>
<summary>Шаг 3.4: Настройки хранилища и партиционирования, профиль пользователя</summary>
</br><img src="img/1_vm_install/install-12.png" width="1000" />
</br><img src="img/1_vm_install/install-13.png" width="1000" />
</br><img src="img/1_vm_install/install-14.png" width="1000" />
</br><img src="img/1_vm_install/install-15.png" width="1000" />
</br><img src="img/1_vm_install/install-16.png" width="1000" />
</details>

<details>
<summary>Шаг 3.5: Featured server snaps (сторонные ПО)</summary>
</br><img src="img/1_vm_install/install-19.png" width="1000" />
</br><img src="img/1_vm_install/install-18.png" width="1000" />
</details>

> [!CAUTION]
> Обращаем внимание на то, что самая высокая версия, доступна таким способом не является самой свежой. В момент создание этого проекта, самая свежый релиз *etcd* - 3.6.7 <sup id="a1">[(1)](#f1)</sup>

После заполнения всех деталей и проверки, выпольняется установка.
</br><img src="img/1_vm_install/install-20.png" width="1000" />


#### Клонирование первой виртуалной машины




### Настраивание модули управления Patroni



### Тестирование переключения и отказоустойчивости кластера




## Список использованных источников:

1. [Скачать Ubuntu Server 24.04 LTS](https://ubuntu.com/download/server)
2.
3.
4.

[^1]: ceci est un test 


## Замечания



<b id="f1">1</b> [Последный релиз etcd](https://github.com/etcd-io/etcd/releases/) [↩](#a1)
